name: Vercel CD Deployment (Fixed Yarn Version)

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  NODE_VERSION: 20.x
  YARN_VERSION: 4.7.0 # Doit correspondre à packageManager dans package.json

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      # Étape cruciale pour gérer Corepack et Yarn moderne
      - name: Enable Corepack and Set Yarn Version
        run: |
          # Active Corepack (inclus dans Node.js ≥16.9)
          corepack enable

          # Prépare la version exacte spécifiée dans package.json
          corepack prepare yarn@${{ env.YARN_VERSION }} --activate

          # Vérification
          echo "Yarn version: $(yarn --version)"

      - name: Install dependencies
        run: |
          # Force l'utilisation de la version configurée par Corepack
          yarn install --immutable

      - name: Build project
        run: yarn build

      - name: Deploy to Vercel
        run: |
          vercel pull --yes --token=${{ env.VERCEL_TOKEN }}
          vercel deploy --prod --token=${{ env.VERCEL_TOKEN }}
